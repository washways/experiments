<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OECD Expenditure Explorer — LDCs (2018–2023)</title>

<!-- Inline favicon -->
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="%230b1020"/><circle cx="32" cy="32" r="18" fill="%236aa0ff"/></svg>'>

<link rel="preconnect" href="https://cdn.plot.ly" crossorigin>
<style>
  :root { --bg:#0b1020; --fg:#e8ebf2; --muted:#9aa3b2; --card:#141a2f; --accent:#6aa0ff; }
  html,body { margin:0; height:100%; background:var(--bg); color:var(--fg); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial;}
  header { padding:20px; border-bottom:1px solid #1e2746; }
  h1 { margin:0 0 8px 0; font-size:20px; }
  .sub { color:#9aa3b2; }
  main { display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:16px; }
  .panel { background:var(--card); border:1px solid #1e2746; border-radius:14px; padding:14px; }
  label { display:block; margin-top:10px; color:#cbd3e3; font-weight:600; }
  select { width:100%; min-height:84px; background:#0e1430; color:var(--fg); border:1px solid #2a3359; border-radius:10px; padding:6px; }
  .kpi { display:flex; gap:16px; margin-top:8px; flex-wrap:wrap; }
  .badge { padding:6px 10px; border-radius:999px; background:#0e1430; border:1px solid #263058; color:#cbd3e3; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th, td { padding:8px 10px; border-bottom:1px solid #1f2748; }
  th { text-align:left; color:#cbd3e3; }
  .footer { color:var(--muted); font-size:12px; margin-top:8px; }
  .btn { display:inline-block; padding:8px 12px; border-radius:10px; border:1px solid #2a3359; background:#0f1736; color:#dbe4ff; text-decoration:none; cursor:pointer; }
  .btn:disabled { opacity:.6; cursor:not-allowed; }
  .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .hint { color:#9aa3b2; font-size:12px; margin-top:6px;}
  @media (max-width: 980px) { main { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<header>
  <h1>OECD Expenditure Explorer</h1>
  <div class="sub">
    OECD aid <b>disbursements</b> to <b>LDCs</b>, years <span id="yearsBadge">…</span>.<br/>
    Filter by Country, Donor, Sector, Climate tag. Chart shows flows <b>Total → Donor → Climate → Sector</b>.<br/>
    Hover to see amounts in <b>M USD</b>.
  </div>
</header>

<main>
  <section class="panel" id="controls">
    <div class="kpi">
      <span class="badge" id="rowsBadge">Rows: …</span>
      <span class="badge" id="sumBadge">Total: … M USD</span>
    </div>

    <label>Country (LDC) — hold Ctrl/Cmd to multi-select</label>
    <select id="countrySel" multiple></select>
    <label>Donor — hold Ctrl/Cmd to multi-select</label>
    <select id="donorSel" multiple></select>
    <label>Sector — hold Ctrl/Cmd to multi-select</label>
    <select id="sectorSel" multiple></select>
    <label>Climate tag (Rio marker)</label>
    <select id="rioSel" multiple></select>

    <div class="row" style="margin-top:10px;">
      <button class="btn" id="applyBtn">Apply filters</button>
      <span class="hint">Tip: start with fewer Countries/Donors for speed, then expand.</span>
    </div>

    <div class="footer">
      Source: OECD DAC CRS. © OECD. Licensed under CC BY 4.0. Values shown in <b>M USD</b>.
    </div>
  </section>

  <section class="panel">
    <div id="chart" style="height:640px;"></div>
    <div id="table"></div>
  </section>
</main>

<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script>
const DATA_URL = "/experiments/data/crs_ldc_2018_2023.json"; // <-- this file must exist in your repo

const rowsBadge = document.getElementById('rowsBadge');
const sumBadge  = document.getElementById('sumBadge');

let DATA = null;

function fillSelect(id, arr, pre=10){
  const sel = document.getElementById(id); sel.innerHTML="";
  arr.forEach((v,i)=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; if(i<pre) o.selected=true; sel.appendChild(o); });
}

function getSel(id){
  return [...document.getElementById(id).selectedOptions].map(o=>o.value);
}

function human(n){ return (+n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }

async function main(){
  const resp = await fetch(DATA_URL, {cache:"no-store"});
  if(!resp.ok){ throw new Error("Failed to load data: "+resp.status); }
  DATA = await resp.json();

  document.getElementById('yearsBadge').textContent = `${DATA.meta.years[0]}–${DATA.meta.years[1]}`;

  fillSelect('countrySel', DATA.distinct.countries, Math.min(10, DATA.distinct.countries.length));
  fillSelect('donorSel', DATA.distinct.donors, Math.min(10, DATA.distinct.donors.length));
  fillSelect('sectorSel', DATA.distinct.sectors, DATA.distinct.sectors.length);
  fillSelect('rioSel', DATA.distinct.rios, DATA.distinct.rios.length);

  document.getElementById('applyBtn').addEventListener('click', render);
  ["countrySel","donorSel","sectorSel","rioSel"].forEach(id=>{
    document.getElementById(id).addEventListener('change', ()=>{ clearTimeout(window.__t); window.__t=setTimeout(render,200); });
  });

  render();
}

function render(){
  const c = new Set(getSel('countrySel'));
  const d = new Set(getSel('donorSel'));
  const s = new Set(getSel('sectorSel'));
  const r = new Set(getSel('rioSel'));

  const filtered = DATA.records.filter(row =>
    c.has(row.Country) && d.has(row.Donor) && s.has(row.Sector) && r.has(row.RioMarker)
  );

  rowsBadge.textContent = `Rows: ${filtered.length.toLocaleString()}`;
  const totalM = filtered.reduce((a,x)=>a + (+x.usd_m), 0);
  sumBadge.textContent = `Total: ${human(totalM)} M USD`;

  // Build Sankey arrays  (Total → Donor → Rio → Sector)
  const labels = ["Total Aid"];
  const mapIdx = (lab)=>{ let i=labels.indexOf(lab); if(i===-1){labels.push(lab); i=labels.length-1;} return i; };
  const src=[], tgt=[], val=[];

  // Donor totals
  const byDonor = new Map();
  filtered.forEach(r=> byDonor.set(r.Donor, (byDonor.get(r.Donor)||0) + r.usd_m));
  for (const [donor,v] of byDonor) { src.push(mapIdx("Total Aid")); tgt.push(mapIdx(donor)); val.push(v); }

  // Donor → Rio
  const byDonorRio = new Map(); // key: donor|rio
  filtered.forEach(r=>{
    const k = r.Donor + "|" + r.RioMarker;
    byDonorRio.set(k, (byDonorRio.get(k)||0) + r.usd_m);
  });
  for (const [k,v] of byDonorRio){
    const [donor,rio] = k.split("|");
    src.push(mapIdx(donor)); tgt.push(mapIdx(rio)); val.push(v);
  }

  // Rio → Sector
  const byRioSector = new Map();
  filtered.forEach(r=>{
    const k = r.RioMarker + "|" + r.Sector;
    byRioSector.set(k, (byRioSector.get(k)||0) + r.usd_m);
  });
  for (const [k,v] of byRioSector){
    const [rio,sector] = k.split("|");
    src.push(mapIdx(rio)); tgt.push(mapIdx(sector)); val.push(v);
  }

  Plotly.react("chart", [{
    type:"sankey",
    node:{ label:labels, pad:15, thickness:20, hovertemplate:"%{label}<extra></extra>" },
    link:{ source:src, target:tgt, value:val, hovertemplate:"Flow: %{value:.2f} M USD<extra></extra>" }
  }], { title:`Aid Flow (${DATA.meta.years[0]}–${DATA.meta.years[1]}): Total → Donor → Climate → Sector`,
        font:{size:12}, paper_bgcolor:"transparent", plot_bgcolor:"transparent",
        height:640, margin:{t:40,l:10,r:10,b:10} });

  // Table
  const el=document.getElementById('table'); el.innerHTML="";
  const t=document.createElement('table');
  t.innerHTML = `<thead><tr><th>Donor</th><th>Climate</th><th>Sector</th><th>USD (M)</th></tr></thead>`;
  const tb=document.createElement('tbody');

  // Donor,Rio,Sector rollup for the table
  const key = (r)=> r.Donor+"|"+r.RioMarker+"|"+r.Sector;
  const agg = new Map();
  filtered.forEach(r=> agg.set(key(r), (agg.get(key(r))||0)+r.usd_m));
  const rows = [...agg.entries()].map(([k,v])=>{ const [Donor,RioMarker,Sector] = k.split("|"); return {Donor,RioMarker,Sector,usd_m:v}; })
                                 .sort((a,b)=> a.Donor.localeCompare(b.Donor) || a.RioMarker.localeCompare(b.RioMarker) || a.Sector.localeCompare(b.Sector));

  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.Donor}</td><td>${r.RioMarker}</td><td>${r.Sector}</td><td>${human(r.usd_m)}</td>`;
    tb.appendChild(tr);
  });
  t.appendChild(tb); el.appendChild(t);
}

main().catch(err=>{
  console.error(err);
  alert("Failed to load data: "+err.message);
});
</script>
</body>
</html>
