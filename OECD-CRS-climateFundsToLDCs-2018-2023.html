<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OECD Expenditure Explorer — LDCs (2018–2023)</title>

<!-- Inline favicon to silence 404 -->
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="%230b1020"/><circle cx="32" cy="32" r="18" fill="%236aa0ff"/></svg>'>

<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://cdn.plot.ly" crossorigin>
<style>
  :root { --bg:#0b1020; --fg:#e8ebf2; --muted:#9aa3b2; --card:#141a2f; --accent:#6aa0ff; }
  html,body { margin:0; height:100%; background:var(--bg); color:var(--fg); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial;}
  header { padding:20px; border-bottom:1px solid #1e2746; }
  h1 { margin:0 0 8px 0; font-size:20px; }
  .sub { color:#9aa3b2; }
  main { display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:16px; }
  .panel { background:var(--card); border:1px solid #1e2746; border-radius:14px; padding:14px; }
  label { display:block; margin-top:10px; color:#cbd3e3; font-weight:600; }
  select { width:100%; min-height:84px; background:#0e1430; color:var(--fg); border:1px solid #2a3359; border-radius:10px; padding:6px; }
  .kpi { display:flex; gap:16px; margin-top:8px; flex-wrap:wrap; }
  .badge { padding:6px 10px; border-radius:999px; background:#0e1430; border:1px solid #263058; color:#cbd3e3; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th, td { padding:8px 10px; border-bottom:1px solid #1f2748; }
  th { text-align:left; color:#cbd3e3; }
  .footer { color:var(--muted); font-size:12px; margin-top:8px; }
  .btn { display:inline-block; padding:8px 12px; border-radius:10px; border:1px solid #2a3359; background:#0f1736; color:#dbe4ff; text-decoration:none; cursor:pointer; }
  .btn:disabled { opacity:.6; cursor:not-allowed; }
  .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .hint { color:#9aa3b2; font-size:12px; margin-top:6px;}
  @media (max-width: 980px) { main { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<header>
  <h1>OECD Expenditure Explorer</h1>
  <div class="sub">
    OECD aid <b>disbursements</b> to <b>LDCs</b>, years <span id="yearsBadge">…</span>. Filter by Country, Donor, Sector, Climate tag.<br/>
    Chart shows flows: <b>Total → Donor → Climate → Sector</b>. Hover to see amounts in <b>M USD</b>.
  </div>
</header>

<main>
  <section class="panel" id="controls">
    <div class="kpi">
      <span class="badge" id="rowsBadge">Rows: …</span>
      <span class="badge" id="sumBadge">Total: … M USD</span>
    </div>

    <label>Country (LDC) — hold Ctrl/Cmd to multi-select</label>
    <select id="countrySel" multiple></select>
    <label>Donor — hold Ctrl/Cmd to multi-select</label>
    <select id="donorSel" multiple></select>
    <label>Sector — hold Ctrl/Cmd to multi-select</label>
    <select id="sectorSel" multiple></select>
    <label>Climate tag (Rio marker)</label>
    <select id="rioSel" multiple></select>

    <div class="row" style="margin-top:10px;">
      <button class="btn" id="applyBtn">Apply filters</button>
      <span class="hint">Tip: start with fewer Countries/Donors for speed, then expand.</span>
    </div>

    <div class="footer">
      Source: OECD DAC CRS. © OECD. Licensed under CC BY 4.0. Values shown in <b>M USD</b>.
    </div>
  </section>

  <section class="panel">
    <div id="chart" style="height:640px;"></div>
    <div id="table"></div>
  </section>
</main>

<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<script type="module">
  import * as duckdb from "https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.0/+esm";

  // ---------- STRONG ERROR LOGGING ----------
  const log = (...a)=>console.log("[OECD-CRS]", ...a);
  const err = (...a)=>console.error("[OECD-CRS]", ...a);
  window.addEventListener("error", (e)=>err("window error:", e.message, e.error||"", e));
  window.addEventListener("unhandledrejection", (e)=>err("unhandled rejection:", e.reason||e));

  // ---------- FORCE MVP via bundle discovery ----------
  // Use official helper to find exact CDN URLs, then pick the MVP bundle (no COOP/COEP).
  const bundles = duckdb.getJsDelivrBundles();
  const mvp = bundles.find(b => /mvp/i.test(b.name));
  if (!mvp) throw new Error("DuckDB MVP bundle not found");

  // ---------- SAME-ORIGIN BLOB WORKER with locateFile ----------
  // The MVP worker expects to resolve 'duckdb-mvp.wasm'. Set locateFile to the CDN dist dir.
  const wasmDir = mvp.mainModule.substring(0, mvp.mainModule.lastIndexOf('/') + 1);
  const workerBlobURL = URL.createObjectURL(new Blob([`
    self.DUCKDB_CONFIG = { locateFile: (f) => ${JSON.stringify(wasmDir)} + f };
    self.addEventListener('error', e => { try { self.postMessage({__duckdb_worker_error: String(e.message||e)}); } catch(_){} });
    self.addEventListener('unhandledrejection', e => { try { self.postMessage({__duckdb_worker_error: 'unhandledrejection: ' + String(e.reason||e)}); } catch(_){} });
    importScripts(${JSON.stringify(mvp.mainWorker)});
  `], { type: "application/javascript" }));

  const worker = new Worker(workerBlobURL);
  worker.addEventListener('message', (e)=>{
    if (e && e.data && e.data.__duckdb_worker_error) {
      err("Worker inner error:", e.data.__duckdb_worker_error);
    }
  });
  worker.addEventListener('error', (e)=>err("Worker event error:", e.message||e));

  const db = new duckdb.AsyncDuckDB(new duckdb.ConsoleLogger(), worker);

  // Pass absolute WASM URL from the MVP bundle
  await db.instantiate(mvp.mainModule /* no pthread in MVP */).catch(e=>{
    err("instantiate failed:", e);
    throw e;
  });

  const conn = await db.connect();

  // ---------- HTTPFS (for remote parquet) ----------
  await conn.query(`INSTALL httpfs; LOAD httpfs;`).catch(e=>{ err("httpfs load failed:", e); throw e; });
  await conn.query(`SET enable_http_metadata_cache=true; SET enable_object_cache=true;`);

  // ---------- DATA SOURCES ----------
  // If you mirror these into your repo later, just swap to same-origin URLs.
  const PARQUET_URLS = [
    "https://huggingface.co/datasets/wash/OECD-CRS-data/resolve/main/CRS_2018.parquet",
    "https://huggingface.co/datasets/wash/OECD-CRS-data/resolve/main/CRS_2019.parquet",
    "https://huggingface.co/datasets/wash/OECD-CRS-data/resolve/main/CRS_2020.parquet",
    "https://huggingface.co/datasets/wash/OECD-CRS-data/resolve/main/CRS_2021.parquet",
    "https://huggingface.co/datasets/wash/OECD-CRS-data/resolve/main/CRS_2022.parquet",
    "https://huggingface.co/datasets/wash/OECD-CRS-data/resolve/main/CRS_2023.parquet"
  ];

  const LDCs = new Set([
    'Afghanistan','Angola','Bangladesh','Benin','Bhutan','Burkina Faso','Burundi',
    'Cambodia','Central African Republic','Chad','Comoros','Democratic Republic of the Congo',
    'Djibouti','Eritrea','Ethiopia','Gambia','Guinea','Guinea-Bissau','Haiti','Kiribati',
    "Lao People's Democratic Republic",'Lesotho','Liberia','Madagascar','Malawi','Mali',
    'Mauritania','Mozambique','Myanmar','Nepal','Niger','Rwanda','Sao Tome and Principe',
    'Senegal','Sierra Leone','Solomon Islands','Somalia','South Sudan','Sudan','Timor-Leste',
    'Togo','Tuvalu','Uganda','United Republic of Tanzania','Yemen','Zambia'
  ]);

  const toArray = (table) => {
    const cols = table.schema.fields.map(f => f.name), out=[];
    for (let i=0;i<table.numRows;i++){ const r={}; for (let c=0;c<cols.length;c++) r[cols[c]]=table.getChild(c).get(i); out.push(r); }
    return out;
  };
  const fillSelect = (id, arr, pre=10) => {
    const sel=document.getElementById(id); sel.innerHTML="";
    arr.forEach((v,i)=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; if(i<pre) o.selected=true; sel.appendChild(o); });
  };

  // ---------- PARQUET SCAN (use read_parquet([...])) ----------
  const fileListLiteral = `[${PARQUET_URLS.map(u => `'${u.replace(/'/g, "''")}'`).join(', ')}]`;
  await conn.query(`
    CREATE OR REPLACE VIEW crs AS
    SELECT
      recipient_name::VARCHAR AS Country,
      donor_name::VARCHAR      AS Donor,
      purpose_code::VARCHAR    AS purpose_code,
      CAST(year AS INT)        AS year,
      CAST(usd_disbursement AS DOUBLE) AS usd_disbursement,
      CAST(climate_adaptation AS INT)  AS climate_adaptation,
      CAST(climate_mitigation AS INT)  AS climate_mitigation
    FROM read_parquet(${fileListLiteral})
    WHERE usd_disbursement IS NOT NULL AND usd_disbursement > 0
  `).catch(e=>{ err("read_parquet() failed:", e); throw e; });

  // ---------- last-5-year LDC slice ----------
  const y = await conn.query(`SELECT min(year) AS miny, max(year) AS maxy FROM crs;`).catch(e=>{ err("min/max year failed:", e); throw e; });
  const { miny, maxy } = toArray(y)[0];
  const cutoff = maxy - 4;
  document.getElementById('yearsBadge').textContent = `${cutoff}–${maxy}`;

  await conn.query(`
    CREATE OR REPLACE VIEW crs_ldc5 AS
    SELECT * FROM crs
    WHERE year >= ${cutoff} AND Country IN (${[...LDCs].map(s=> `'${s.replace(/'/g,"''")}'`).join(',')})
  `);

  await conn.query(`
    CREATE OR REPLACE VIEW crs_ldc5_sectors AS
    SELECT
      Country, Donor, year, usd_disbursement, purpose_code,
      CASE
        WHEN LEFT(CAST(purpose_code AS VARCHAR),3) IN ('110','120','130') THEN 'Social Services'
        WHEN LEFT(CAST(purpose_code AS VARCHAR),3) IN ('140','150') THEN 'Water & Other Infra'
        WHEN LEFT(CAST(purpose_code AS VARCHAR),3) IN ('210','220','230') THEN 'Economic Infrastructure'
        WHEN LEFT(CAST(purpose_code AS VARCHAR),3) IN ('310','311','312','313','321','322','323','324') THEN 'Production Sectors'
        WHEN LEFT(CAST(purpose_code AS VARCHAR),3) IN ('410','430') THEN 'Multi-sector / Cross-cutting'
        WHEN LEFT(CAST(purpose_code AS VARCHAR),3) IN ('510','520') THEN 'Humanitarian Aid'
        WHEN LEFT(CAST(purpose_code AS VARCHAR),3) IN ('600','700') THEN 'Debt/Admin/Refugees'
        ELSE 'Other'
      END AS Sector,
      GREATEST(COALESCE(climate_adaptation,0), COALESCE(climate_mitigation,0)) AS rio_score
    FROM crs_ldc5
  `);

  await conn.query(`
    CREATE OR REPLACE VIEW crs_final AS
    SELECT
      Country, Donor, Sector, year, usd_disbursement,
      CASE rio_score WHEN 2 THEN 'Principal' WHEN 1 THEN 'Significant' ELSE 'Not Tagged' END AS RioMarker
    FROM crs_ldc5_sectors
  `);

  // ---------- UI ----------
  const distinct = async (col) => toArray(await conn.query(`SELECT DISTINCT ${col} AS v FROM crs_final ORDER BY ${col};`)).map(r=>r.v);
  const countries = await distinct('Country');
  const donors    = await distinct('Donor');
  const sectors   = await distinct('Sector');
  const rios      = await distinct('RioMarker');

  fillSelect('countrySel', countries, Math.min(10, countries.length));
  fillSelect('donorSel', donors, Math.min(10, donors.length));
  fillSelect('sectorSel', sectors, sectors.length);
  fillSelect('rioSel', rios, rios.length);

  const rowsBadge = document.getElementById('rowsBadge');
  const sumBadge  = document.getElementById('sumBadge');

  async function run(){
    const sv = id => [...document.getElementById(id).selectedOptions].map(o=>o.value.replaceAll("'", "''"));
    const cVals=sv('countrySel'), dVals=sv('donorSel'), sVals=sv('sectorSel'), rVals=sv('rioSel');
    if(!cVals.length||!dVals.length||!sVals.length||!rVals.length){ return; }

    const where = `
      Country IN (${cVals.map(v=>`'${v}'`).join(",")})
      AND Donor IN (${dVals.map(v=>`'${v}'`).join(",")})
      AND Sector IN (${sVals.map(v=>`'${v}'`).join(",")})
      AND RioMarker IN (${rVals.map(v=>`'${v}'`).join(",")})
    `;

    const tbl = toArray(await conn.query(`
      WITH f AS (SELECT * FROM crs_final WHERE ${where})
      SELECT Donor, RioMarker, Sector, SUM(usd_disbursement)/1e6 AS "USD (M)"
      FROM f GROUP BY ALL ORDER BY Donor, RioMarker, Sector;
    `));
    rowsBadge.textContent = `Rows: ${tbl.length.toLocaleString()}`;
    const total = tbl.reduce((a,r)=>a+(+r["USD (M)"]),0);
    sumBadge.textContent = `Total: ${total.toFixed(2)} M USD`;

    // Sankey
    const labels = ["Total Aid"];
    const idx = (l)=>{ let i=labels.indexOf(l); if(i===-1){labels.push(l); i=labels.length-1;} return i; };
    const src=[],tgt=[],val=[];

    const donorsLink = toArray(await conn.query(`
      WITH f AS (SELECT * FROM crs_final WHERE ${where})
      SELECT Donor, SUM(usd_disbursement)/1e6 AS v FROM f GROUP BY Donor;
    `));
    donorsLink.forEach(r=>{ src.push(idx("Total Aid")); tgt.push(idx(r.Donor)); val.push(+r.v); });

    const donorRio = toArray(await conn.query(`
      WITH f AS (SELECT * FROM crs_final WHERE ${where})
      SELECT Donor, RioMarker, SUM(usd_disbursement)/1e6 AS v FROM f GROUP BY Donor,RioMarker;
    `));
    donorRio.forEach(r=>{ src.push(idx(r.Donor)); tgt.push(idx(r.RioMarker)); val.push(+r.v); });

    const rioSector = toArray(await conn.query(`
      WITH f AS (SELECT * FROM crs_final WHERE ${where})
      SELECT RioMarker, Sector, SUM(usd_disbursement)/1e6 AS v FROM f GROUP BY RioMarker,Sector;
    `));
    rioSector.forEach(r=>{ src.push(idx(r.RioMarker)); tgt.push(idx(r.Sector)); val.push(+r.v); });

    Plotly.react("chart", [{
      type:"sankey",
      node:{ label:labels, pad:15, thickness:20, hovertemplate:"%{label}<extra></extra>" },
      link:{ source:src, target:tgt, value:val, hovertemplate:"Flow: %{value:.2f} M USD<extra></extra>" }
    }], { title:`Aid Flow (${cutoff}–${maxy}): Total → Donor → Climate → Sector`,
          font:{size:12}, paper_bgcolor:"transparent", plot_bgcolor:"transparent",
          height:640, margin:{t:40,l:10,r:10,b:10} });

    // Table
    const el=document.getElementById('table'); el.innerHTML="";
    const t=document.createElement('table');
    t.innerHTML = `<thead><tr><th>Donor</th><th>Climate</th><th>Sector</th><th>USD (M)</th></tr></thead>`;
    const tb=document.createElement('tbody');
    tbl.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${r.Donor}</td><td>${r.RioMarker}</td><td>${r.Sector}</td><td>${(+r["USD (M)"]).toFixed(2)}</td>`; tb.appendChild(tr); });
    t.appendChild(tb); el.appendChild(t);
  }

  document.getElementById('applyBtn').addEventListener('click', run);
  await run();
  let t=null; const onSel=()=>{ clearTimeout(t); t=setTimeout(run,200); };
  for (const id of ["countrySel","donorSel","sectorSel","rioSel"]) document.getElementById(id).addEventListener('change', onSel);
</script>
</body>
</html>
