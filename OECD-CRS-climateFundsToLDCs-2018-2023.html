<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OECD Expenditure Explorer — LDCs (2018–2023)</title>

<!-- UNICEF blue theme -->
<style>
  :root {
    --unicef:#1CABE2;
    --bg:#ffffff; --fg:#0b1726; --muted:#4a5a73; --card:#f5f8fb; --border:#d9e3ef;
  }
  html,body { margin:0; height:100%; background:var(--bg); color:var(--fg);
    font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial; }
  header { padding:18px 20px; border-bottom:1px solid var(--border);
           background:linear-gradient(0deg,#fff, #f7fbff); }
  h1 { margin:0 0 6px 0; font-size:22px; font-weight:800; color:#0c2a40; }
  .sub { color:var(--muted); }
  main { display:grid; grid-template-columns: 380px 1fr; gap:16px; padding:16px; }
  .panel { background:var(--card); border:1px solid var(--border);
           border-radius:14px; padding:14px; }
  label { display:block; margin-top:10px; color:#0c2a40; font-weight:700; font-size:13px; }
  select, input[type="number"], select.single { width:100%; background:#fff; color:var(--fg);
           border:1px solid var(--border); border-radius:10px; padding:6px; }
  select[multiple] { min-height:110px; }
  .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .kpi { display:flex; gap:12px; margin-top:8px; flex-wrap:wrap; }
  .badge { padding:6px 10px; border-radius:999px; background:#e9f6fd;
           border:1px solid #cdeafb; color:#074d6d; font-weight:600; }
  table { width:100%; border-collapse: collapse; margin-top:10px; background:#fff;
          border-radius:10px; overflow:hidden; }
  th, td { padding:8px 10px; border-bottom:1px solid var(--border); }
  th { text-align:left; color:#0c2a40; background:#eef7fd; cursor:pointer; user-select:none; }
  th.sort-asc::after { content:" ▲"; font-size:11px; }
  th.sort-desc::after{ content:" ▼"; font-size:11px; }
  .footer { color:var(--muted); font-size:12px; margin-top:8px; }
  .btn { display:inline-block; padding:8px 12px; border-radius:10px;
         border:1px solid #a8d9f3; background:var(--unicef); color:#fff;
         text-decoration:none; cursor:pointer; font-weight:700; }
  @media (max-width: 980px) { main { grid-template-columns: 1fr; } }
  small.hint { color:#5b738a; }
</style>

<link rel="preconnect" href="https://cdn.plot.ly" crossorigin>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="%231CABE2"/><circle cx="32" cy="32" r="18" fill="%23ffffff"/></svg>'>
</head>
<body>
<header>
  <h1>OECD Expenditure Explorer</h1>
  <div class="sub">
    OECD aid <b>disbursements</b> to <b>LDCs</b>, years <span id="yearsBadge">…</span>.<br/>
    Filter by Year, Country, Donor, Sector, Climate tag. Sankey shows
    <b>Total → Donor → Climate → Sector</b><span id="countryStageLabel"> → Country</span>.
    Hover to see amounts in <b>M USD</b>.
  </div>
</header>

<main>
  <section class="panel" id="controls">
    <div class="kpi">
      <span class="badge" id="rowsBadge">Rows: …</span>
      <span class="badge" id="sumBadge">Total: … M USD</span>
    </div>

    <label>Year (multi-select)</label>
    <select id="yearSel" multiple></select>

    <label>Country (LDC, multi-select)</label>
    <select id="countrySel" multiple></select>

    <label>Donor (multi-select)</label>
    <select id="donorSel" multiple></select>

    <label>Sector (multi-select)</label>
    <select id="sectorSel" multiple></select>

    <label>Climate tag (Rio marker, multi-select)</label>
    <select id="rioSel" multiple></select>

    <div class="row">
      <input type="checkbox" id="showCountryStage" checked>
      <label for="showCountryStage" style="margin:0;font-weight:500;">Include Country stage</label>
    </div>

    <div class="row">
      <div style="flex:1">
        <label style="margin-top:0">Min Donor total (M USD)</label>
        <input id="minDonor" type="number" min="0" step="1" value="0">
      </div>
      <div style="flex:1">
        <label style="margin-top:0">Min Sector total (M USD)</label>
        <input id="minSector" type="number" min="0" step="1" value="0">
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <label style="margin-top:0">Min Rio total (M USD)</label>
        <input id="minRio" type="number" min="0" step="1" value="0">
      </div>
      <div style="flex:1">
        <label style="margin-top:0">Min Country total (M USD)</label>
        <input id="minCountry" type="number" min="0" step="1" value="0">
      </div>
    </div>

    <div class="row">
      <div style="flex:1">
        <label style="margin-top:0">Display Multiplier</label>
        <select id="multiplier" class="single">
          <option value="1" selected>1× (parquet is USD)</option>
          <option value="1000">1,000× (parquet is thousands of USD)</option>
          <option value="1000000">1,000,000× (parquet is millions of USD)</option>
        </select>
        <small class="hint">If amounts look 1,000× too small, pick 1,000×. No guessing.</small>
      </div>
    </div>

    <div class="row">
      <button class="btn" id="applyBtn">Apply filters</button>
    </div>

    <div class="footer">
      Source: OECD DAC CRS. © OECD. Licensed under CC BY 4.0. Amounts shown in <b>M USD</b> (after the chosen display multiplier).
    </div>
  </section>

  <section class="panel">
    <div id="chart" style="height:740px;"></div>
    <div id="table"></div>
  </section>
</main>

<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script>
const DATA_URL = "/experiments/data/crs_ldc_2018_2023.json"; // must exist

let DATA = null;
const fmtM = (n)=> (+n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const getSel = (id)=> [...document.getElementById(id).options].filter(o=>o.selected).map(o=>o.value);

function fillSelectAll(id, arr){
  const sel = document.getElementById(id); sel.innerHTML="";
  arr.forEach((v)=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; o.selected=true; sel.appendChild(o); });
}

function applyCutoffs(aggregates, cutoffs){
  const keepDonor   = new Set(Object.entries(aggregates.byDonor).filter(([,v])=>v>=cutoffs.donor).map(([k])=>k));
  const keepRio     = new Set(Object.entries(aggregates.byRio).filter(([,v])=>v>=cutoffs.rio).map(([k])=>k));
  const keepSector  = new Set(Object.entries(aggregates.bySector).filter(([,v])=>v>=cutoffs.sector).map(([k])=>k));
  const keepCountry = new Set(Object.entries(aggregates.byCountry).filter(([,v])=>v>=cutoffs.country).map(([k])=>k));

  return {
    donorTotals: Object.fromEntries(Object.entries(aggregates.byDonor).filter(([k])=>keepDonor.has(k))),
    donorRio: Object.fromEntries(Object.entries(aggregates.byDonorRio).filter(([k])=>{
      const [donor,rio]=k.split("|"); return keepDonor.has(donor)&&keepRio.has(rio);
    })),
    rioSector: Object.fromEntries(Object.entries(aggregates.byRioSector).filter(([k])=>{
      const [rio,sector]=k.split("|"); return keepRio.has(rio)&&keepSector.has(sector);
    })),
    sectorCountry: Object.fromEntries(Object.entries(aggregates.bySectorCountry).filter(([k])=>{
      const [sector,country]=k.split("|"); return keepSector.has(sector)&&keepCountry.has(country);
    })),
    keeps: { keepDonor, keepRio, keepSector, keepCountry }
  };
}

function sortTable(tableState, th){
  const col = th.dataset.col;
  const prev = tableState.sort[col] || 'desc';
  const next = prev === 'asc' ? 'desc' : 'asc';
  tableState.sort = {[col]: next};
  th.parentElement.querySelectorAll('th').forEach(h=>h.classList.remove('sort-asc','sort-desc'));
  th.classList.add(next==='asc'?'sort-asc':'sort-desc');
  tableState.render();
}

function renderTable(rows, showCountry){
  const el=document.getElementById('table'); el.innerHTML="";
  const t=document.createElement('table'); const tb=document.createElement('tbody');
  const headers = showCountry
    ? [{k:'Donor',t:'Donor'},{k:'RioMarker',t:'Climate'},{k:'Sector',t:'Sector'},{k:'Country',t:'Country'},{k:'usd_m',t:'USD (M)'}]
    : [{k:'Donor',t:'Donor'},{k:'RioMarker',t:'Climate'},{k:'Sector',t:'Sector'},{k:'usd_m',t:'USD (M)'}];
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  const tableState = { sort:{usd_m:'desc'}, render: ()=>{} };

  headers.forEach(h=>{
    const th=document.createElement('th'); th.textContent=h.t; th.dataset.col=h.k;
    if (h.k==='usd_m') th.classList.add('sort-desc');
    th.addEventListener('click', ()=>sortTable(tableState, th));
    trh.appendChild(th);
  });
  thead.appendChild(trh); t.appendChild(thead);

  tableState.render = ()=>{
    const [sortCol,dir] = Object.entries(tableState.sort)[0] || ['usd_m','desc'];
    const sorted = [...rows];
    sorted.sort((a,b)=>{
      const av=a[sortCol], bv=b[sortCol];
      if (sortCol==='usd_m') return dir==='asc' ? av-bv : bv-av;
      return dir==='asc' ? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av));
    });
    tb.innerHTML="";
    sorted.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = showCountry
        ? `<td>${r.Donor}</td><td>${r.RioMarker}</td><td>${r.Sector}</td><td>${r.Country}</td><td>${fmtM(r.usd_m)}</td>`
        : `<td>${r.Donor}</td><td>${r.RioMarker}</td><td>${r.Sector}</td><td>${fmtM(r.usd_m)}</td>`;
      tb.appendChild(tr);
    });
  };

  tableState.render();
  t.appendChild(tb); el.appendChild(t);
}

function render(){
  const years = new Set(getSel('yearSel').map(Number));
  const countries = new Set(getSel('countrySel'));
  const donors = new Set(getSel('donorSel'));
  const sectors = new Set(getSel('sectorSel'));
  const rios = new Set(getSel('rioSel'));
  const showCountry = document.getElementById('showCountryStage').checked; // <-- SINGLE declaration
  const mult = Number(document.getElementById('multiplier').value); // 1, 1e3, 1e6

  // Filter
  const selected = DATA.records.filter(r =>
    years.has(r.year) && countries.has(r.Country) && donors.has(r.Donor) &&
    sectors.has(r.Sector) && rios.has(r.RioMarker)
  );

  // Scale: DATA.usd_m is USD/1e6; multiply display by 'mult'
  const fm = selected.map(r => ({...r, usd_m: r.usd_m * mult}));

  // KPIs
  document.getElementById('rowsBadge').textContent = `Rows: ${fm.length.toLocaleString()}`;
  const totalM = fm.reduce((a,x)=>a + x.usd_m, 0);
  document.getElementById('sumBadge').textContent = `Total: ${fmtM(totalM)} M USD`;

  // Aggregates
  const add = (m,k,v)=> m.set(k,(m.get(k)||0)+v);
  const byDonor = new Map(), byRio=new Map(), bySector=new Map(), byCountry=new Map();
  const byDonorRio=new Map(), byRioSector=new Map(), bySectorCountry=new Map();

  fm.forEach(r=>{
    add(byDonor, r.Donor, r.usd_m);
    add(byRio, r.RioMarker, r.usd_m);
    add(bySector, r.Sector, r.usd_m);
    add(byCountry, r.Country, r.usd_m);
    add(byDonorRio, r.Donor+"|"+r.RioMarker, r.usd_m);
    add(byRioSector, r.RioMarker+"|"+r.Sector, r.usd_m);
    add(bySectorCountry, r.Sector+"|"+r.Country, r.usd_m);
  });

  // Cutoffs (M USD)
  const cut = {
    donor:   Math.max(0, Number(document.getElementById('minDonor').value||0)),
    sector:  Math.max(0, Number(document.getElementById('minSector').value||0)),
    rio:     Math.max(0, Number(document.getElementById('minRio').value||0)),
    country: Math.max(0, Number(document.getElementById('minCountry').value||0)),
  };

  const aggObj = {
    byDonor: Object.fromEntries(byDonor),
    byRio: Object.fromEntries(byRio),
    bySector: Object.fromEntries(bySector),
    byCountry: Object.fromEntries(byCountry),
    byDonorRio: Object.fromEntries(byDonorRio),
    byRioSector: Object.fromEntries(byRioSector),
    bySectorCountry: Object.fromEntries(bySectorCountry),
  };
  const pruned = applyCutoffs(aggObj, cut);

  // Sankey
  const labels = ["Total Aid"];
  const idx = (lab)=>{ let i=labels.indexOf(lab); if(i===-1){labels.push(lab); i=labels.length-1;} return i; };
  const src=[], tgt=[], val=[];

  for (const [donor,v] of Object.entries(pruned.donorTotals)) {
    src.push(idx("Total Aid")); tgt.push(idx(donor)); val.push(v);
  }
  for (const [k,v] of Object.entries(pruned.donorRio)) {
    const [donor,rio] = k.split("|");
    src.push(idx(donor)); tgt.push(idx(rio)); val.push(v);
  }
  for (const [k,v] of Object.entries(pruned.rioSector)) {
    const [rio,sector] = k.split("|");
    src.push(idx(rio)); tgt.push(idx(sector)); val.push(v);
  }
  if (showCountry) {
    for (const [k,v] of Object.entries(pruned.sectorCountry)) {
      const [sector,country] = k.split("|");
      src.push(idx(sector)); tgt.push(idx(country)); val.push(v);
    }
  }

  Plotly.react("chart", [{
    type:"sankey",
    node:{ label:labels, pad:15, thickness:18, hovertemplate:"%{label}<extra></extra>" },
    link:{ source:src, target:tgt, value:val, hovertemplate:"Flow: %{value:.2f} M USD<extra></extra>" }
  }], {
    title:`Aid Flow (M USD, multiplier ${mult.toLocaleString()}×)`,
    font:{size:12}, paper_bgcolor:"transparent", plot_bgcolor:"transparent",
    height: showCountry ? 740 : 660, margin:{t:40,l:10,r:10,b:10}
  });

  // Table
  const key = (r)=> showCountry
    ? r.Donor+"|"+r.RioMarker+"|"+r.Sector+"|"+r.Country
    : r.Donor+"|"+r.RioMarker+"|"+r.Sector;
  const tmap = new Map();
  fm.forEach(r=> tmap.set(key(r),(tmap.get(key(r))||0)+r.usd_m));
  const rows = [...tmap.entries()].map(([k,v])=>{
    const parts = k.split("|");
    return showCountry
      ? {Donor:parts[0], RioMarker:parts[1], Sector:parts[2], Country:parts[3], usd_m:v}
      : {Donor:parts[0], RioMarker:parts[1], Sector:parts[2], usd_m:v};
  });

  renderTable(rows, showCountry);
}

async function main(){
  const resp = await fetch(DATA_URL, {cache:"no-store"});
  if(!resp.ok) throw new Error("Failed to load data: "+resp.status);
  DATA = await resp.json();
  document.getElementById('yearsBadge').textContent = `${DATA.meta.years[0]}–${DATA.meta.years[1]}`;

  // Select ALL by default
  fillSelectAll('yearSel', DATA.distinct.years.map(String));
  fillSelectAll('countrySel', DATA.distinct.countries);
  fillSelectAll('donorSel', DATA.distinct.donors);
  fillSelectAll('sectorSel', DATA.distinct.sectors);
  fillSelectAll('rioSel', DATA.distinct.rios);

  // Events
  ['applyBtn','yearSel','countrySel','donorSel','sectorSel','rioSel','showCountryStage','minDonor','minSector','minRio','minCountry','multiplier']
    .forEach(id=>{
      const el = document.getElementById(id);
      (id==='applyBtn')
        ? el.addEventListener('click', render)
        : el.addEventListener('change', ()=>{ clearTimeout(window.__t); window.__t=setTimeout(render,150);});
    });

  render();
}
main().catch(err=>{ console.error(err); alert("Failed to load: "+err.message); });
</script>
</body>
</html>
