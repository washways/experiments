<!doctype html><meta charset="utf-8">
<title>DuckDB Smoke Test (inline worker)</title>
<pre id="out" style="white-space:pre-wrap;font:13px/1.4 ui-monospace,monospace">boot…</pre>
<script type="module">
  import * as duckdb from "https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.0/+esm";

  const out = document.getElementById('out');
  const log = (...a)=>{ console.log("[SMOKE]", ...a); out.textContent += "\n" + a.join(" "); };

  const DIST = "https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.0/dist/";
  const CDN_WORKER = DIST + "duckdb-browser-mvp.worker.js?v=smoke2";
  const CDN_WASM   = DIST + "duckdb-mvp.wasm?v=smoke2";

  try {
    log("fetch worker js…", CDN_WORKER);
    const resJS = await fetch(CDN_WORKER, { cache: "no-store", mode: "cors" });
    if (!resJS.ok) throw new Error("worker fetch " + resJS.status);
    const workerJS = await resJS.text();

    const workerSrc =
`self.DUCKDB_CONFIG = {
  extensionRepository: "",
  locateFile: (f) => ${JSON.stringify(DIST)} + f + "?v=smoke2"
};
` + workerJS;

    log("spin worker…");
    const workerURL = URL.createObjectURL(new Blob([workerSrc], { type: "application/javascript" }));
    const worker = new Worker(workerURL);
    worker.onerror = (e)=> log("WORKER onerror:", e.message || e);

    log("instantiate wasm…", CDN_WASM);
    const db = new duckdb.AsyncDuckDB(new duckdb.ConsoleLogger(), worker);
    await db.instantiate(CDN_WASM);
    log("instantiate ok");

    const conn = await db.connect();
    const res1 = await conn.query("select 1 as ok");

    // Arrow Table → read first col, first row
    const val = res1.getChild(0).get(0);   // or: res1.getChild('ok').get(0)
    log("query ok:", val);                 // should print 1
    log("DONE");
  } catch (e) {
    log("ERROR:", e && e.message ? e.message : e);
    console.error(e);
  }
</script>
